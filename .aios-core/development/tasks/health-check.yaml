---
# Health Check Task Definition
# Story: HCS-2 - Health Check System Implementation
# Version: 1.0.0

name: health-check
id: health-check
version: "2.0"
description: |
  Run comprehensive health checks on your AIOS project.
  Diagnoses configuration issues, environment problems, and provides
  auto-fixing for common issues.

category: development
owner: devops

# CLI integration
command: "*health-check"
aliases:
  - "*hc"
  - "*doctor"

# Task parameters
parameters:
  - name: mode
    type: string
    default: "quick"
    description: "Execution mode: 'quick' (<10s, critical/high only) or 'full' (<60s, all checks)"
    options:
      - quick
      - full

  - name: domain
    type: string
    default: "all"
    description: "Domain to check: project, local, repository, deployment, services, or all"
    options:
      - all
      - project
      - local
      - repository
      - deployment
      - services

  - name: fix
    type: boolean
    default: true
    description: "Enable auto-fixing for Tier 1 issues"

  - name: fix-tier
    type: number
    default: 1
    description: "Maximum tier for auto-fixing (1=silent, 2=prompted, 3=manual guide only)"
    min: 1
    max: 3

  - name: output
    type: string
    default: "console"
    description: "Output format"
    options:
      - console
      - markdown
      - json

  - name: verbose
    type: boolean
    default: false
    description: "Show all checks, not just issues"

  - name: save
    type: boolean
    default: false
    description: "Save report to .aios/reports/health-check-latest.json"

# Execution steps
steps:
  - id: initialize
    name: "Initialize Health Check"
    action: log
    params:
      message: "ðŸ¥ Starting AIOS Health Check (mode: {{mode}})"

  - id: run-checks
    name: "Run Health Checks"
    action: script
    script: |
      const { HealthCheck } = require('../../core/health-check');

      const config = {
        mode: '{{mode}}',
        autoFix: {{fix}},
        autoFixTier: {{fix-tier}},
        output: {
          format: '{{output}}',
          verbose: {{verbose}},
        },
      };

      const healthCheck = new HealthCheck(config);

      const options = {
        domain: '{{domain}}',
      };

      const results = await healthCheck.run(options);

      // Display report
      console.log(results.report);

      // Save if requested
      if ({{save}}) {
        const fs = require('fs').promises;
        const path = require('path');

        const reportDir = path.join(process.cwd(), '.aios', 'reports');
        await fs.mkdir(reportDir, { recursive: true });

        const reportPath = path.join(reportDir, 'health-check-latest.json');
        await fs.writeFile(reportPath, JSON.stringify(results, null, 2));

        console.log(`\nðŸ“„ Report saved to: ${reportPath}`);
      }

      // Return summary for task output
      return {
        score: results.overall.score,
        status: results.overall.status,
        issues: results.overall.issuesCount,
        autoFixed: results.autoFixed?.length || 0,
      };

  - id: summary
    name: "Display Summary"
    action: log
    params:
      message: |

        Health Check Complete:
        - Score: {{run-checks.score}}/100
        - Status: {{run-checks.status}}
        - Issues: {{run-checks.issues}}
        - Auto-fixed: {{run-checks.autoFixed}}

# Output schema
output:
  type: object
  properties:
    score:
      type: number
      description: "Overall health score (0-100)"
    status:
      type: string
      description: "Health status: healthy, degraded, warning, critical"
    issues:
      type: number
      description: "Number of issues found"
    autoFixed:
      type: number
      description: "Number of issues auto-fixed"

# Examples
examples:
  - name: "Quick check"
    command: "*health-check"
    description: "Run quick health check (critical and high severity)"

  - name: "Full check"
    command: "*health-check --mode=full"
    description: "Run comprehensive health check"

  - name: "Check specific domain"
    command: "*health-check --domain=repository"
    description: "Check only repository health"

  - name: "With auto-fix confirmation"
    command: "*health-check --fix-tier=2"
    description: "Allow prompted auto-fixes"

  - name: "Save JSON report"
    command: "*health-check --output=json --save"
    description: "Generate and save JSON report"

  - name: "Verbose output"
    command: "*health-check --verbose"
    description: "Show all checks including passed ones"

# Help text
help: |
  ## AIOS Health Check

  Diagnoses issues in your AIOS project across 5 domains:

  - **Project**: package.json, dependencies, framework config
  - **Local**: Git, npm, IDE, disk space, memory, network
  - **Repository**: Git status, branches, conflicts, lockfile
  - **Deployment**: Environment files, CI/CD, Docker
  - **Services**: MCP, GitHub CLI, Claude Code, APIs

  ### Quick Start

  ```bash
  *health-check              # Quick check
  *health-check --mode=full  # Full check
  ```

  ### Auto-Fixing

  Issues are classified into 3 tiers:
  - **Tier 1**: Auto-fixed silently (safe, reversible)
  - **Tier 2**: Prompted for confirmation
  - **Tier 3**: Manual guide provided

  ### Output Formats

  - `console`: Colorful terminal output
  - `markdown`: GitHub-compatible markdown
  - `json`: Machine-readable JSON

  ### Examples

  ```bash
  *health-check --domain=repository --verbose
  *health-check --fix-tier=2 --save
  *hc --mode=full --output=markdown
  ```
